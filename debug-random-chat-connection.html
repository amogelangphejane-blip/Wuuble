<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Video Chat Connection Diagnostics</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin: 10px 5px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 2px 0;
        }
        .log-entry.error { color: #d32f2f; }
        .log-entry.success { color: #2e7d32; }
        .log-entry.warning { color: #f57c00; }
        .log-entry.info { color: #1976d2; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 30px; }
        h2 { color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Random Video Chat Connection Diagnostics</h1>
        
        <div class="status info">
            <strong>Server URL:</strong> <span id="serverUrl">https://wuuble.onrender.com</span>
        </div>
        
        <div class="status info">
            <strong>User ID:</strong> <span id="userId">test-user-12345</span>
        </div>

        <h2>Connection Tests</h2>
        
        <button onclick="testServerPing()">üåê Test Server Ping</button>
        <button onclick="testSocketIOConnection()">üîå Test Socket.IO Connection</button>
        <button onclick="testWebRTC()">üìπ Test WebRTC Support</button>
        <button onclick="testMediaPermissions()">üé• Test Media Permissions</button>
        <button onclick="clearLog()">üßπ Clear Log</button>
        
        <div id="connectionStatus" class="status info">
            <strong>Status:</strong> Ready to test
        </div>
        
        <h2>Test Results & Logs</h2>
        <div id="logContainer" class="log">
            <div class="log-entry info">Ready to start diagnostics...</div>
        </div>

        <h2>Common Issues & Solutions</h2>
        <div class="status warning">
            <strong>Cannot connect to chat service:</strong>
            <ul>
                <li>Server may be down or unreachable</li>
                <li>Network connectivity issues</li>
                <li>CORS policy blocking the connection</li>
                <li>Missing Socket.IO client dependencies</li>
                <li>Invalid authentication or user session</li>
            </ul>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const serverUrl = 'https://wuuble.onrender.com';
        const userId = 'test-user-' + Math.random().toString(36).substr(2, 9);
        
        document.getElementById('serverUrl').textContent = serverUrl;
        document.getElementById('userId').textContent = userId;
        
        let logContainer = document.getElementById('logContainer');
        let connectionStatus = document.getElementById('connectionStatus');
        
        function updateStatus(message, type = 'info') {
            connectionStatus.className = `status ${type}`;
            connectionStatus.innerHTML = `<strong>Status:</strong> ${message}`;
        }
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function clearLog() {
            logContainer.innerHTML = '<div class="log-entry info">Log cleared...</div>';
            updateStatus('Ready to test', 'info');
        }
        
        async function testServerPing() {
            addLog('üåê Testing server ping...', 'info');
            updateStatus('Testing server connectivity...', 'warning');
            
            try {
                const response = await fetch(serverUrl, { 
                    method: 'GET',
                    mode: 'no-cors'  // Avoid CORS issues for basic connectivity test
                });
                addLog('‚úÖ Server is reachable', 'success');
                updateStatus('Server ping successful', 'success');
            } catch (error) {
                addLog(`‚ùå Server ping failed: ${error.message}`, 'error');
                updateStatus('Server is not reachable', 'error');
            }
        }
        
        function testSocketIOConnection() {
            addLog('üîå Testing Socket.IO connection...', 'info');
            updateStatus('Connecting to Socket.IO server...', 'warning');
            
            const socket = io(serverUrl, {
                transports: ['websocket'],
                timeout: 10000,
                auth: {
                    userId: userId
                }
            });
            
            socket.on('connect', () => {
                addLog('‚úÖ Socket.IO connection successful', 'success');
                updateStatus('Socket.IO connected', 'success');
                
                // Test joining random chat queue
                addLog('üì° Joining random chat queue...', 'info');
                socket.emit('join-random-queue');
            });
            
            socket.on('connect_error', (error) => {
                addLog(`‚ùå Socket.IO connection failed: ${error.message}`, 'error');
                updateStatus('Socket.IO connection failed', 'error');
            });
            
            socket.on('disconnect', (reason) => {
                addLog(`üîå Socket.IO disconnected: ${reason}`, 'warning');
                updateStatus('Socket.IO disconnected', 'warning');
            });
            
            socket.on('queue-joined', (data) => {
                addLog(`üìä Joined queue: position ${data.position}`, 'success');
                updateStatus('In queue for random chat', 'success');
            });
            
            socket.on('queue-status', (data) => {
                addLog(`üìä Queue status: position ${data.position}, wait time: ${data.estimatedWaitTime}s`, 'info');
            });
            
            socket.on('matched', (data) => {
                addLog(`üéØ Matched with partner! Room: ${data.roomId}`, 'success');
                updateStatus('Successfully matched with partner', 'success');
                socket.disconnect();
            });
            
            socket.on('error', (error) => {
                addLog(`‚ùå Socket error: ${error}`, 'error');
                updateStatus('Socket error occurred', 'error');
            });
            
            // Cleanup after 15 seconds
            setTimeout(() => {
                if (socket.connected) {
                    addLog('‚è∞ Test timeout, disconnecting...', 'warning');
                    socket.disconnect();
                }
            }, 15000);
        }
        
        function testWebRTC() {
            addLog('üìπ Testing WebRTC support...', 'info');
            updateStatus('Checking WebRTC capabilities...', 'warning');
            
            // Check WebRTC support
            if (!window.RTCPeerConnection) {
                addLog('‚ùå WebRTC not supported in this browser', 'error');
                updateStatus('WebRTC not supported', 'error');
                return;
            }
            
            addLog('‚úÖ WebRTC is supported', 'success');
            
            // Test STUN servers
            const pc = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            });
            
            pc.createDataChannel('test');
            
            pc.createOffer().then(offer => {
                addLog('‚úÖ WebRTC offer creation successful', 'success');
                return pc.setLocalDescription(offer);
            }).then(() => {
                addLog('‚úÖ Local description set successfully', 'success');
                updateStatus('WebRTC is working correctly', 'success');
            }).catch(error => {
                addLog(`‚ùå WebRTC test failed: ${error.message}`, 'error');
                updateStatus('WebRTC test failed', 'error');
            });
            
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    addLog(`üßä ICE candidate: ${event.candidate.candidate.substring(0, 50)}...`, 'info');
                }
            };
            
            setTimeout(() => pc.close(), 5000);
        }
        
        async function testMediaPermissions() {
            addLog('üé• Testing media permissions...', 'info');
            updateStatus('Requesting media permissions...', 'warning');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                
                addLog('‚úÖ Camera and microphone access granted', 'success');
                updateStatus('Media permissions granted', 'success');
                
                const videoTracks = stream.getVideoTracks();
                const audioTracks = stream.getAudioTracks();
                
                addLog(`üìπ Video tracks: ${videoTracks.length}`, 'info');
                addLog(`üé§ Audio tracks: ${audioTracks.length}`, 'info');
                
                if (videoTracks.length > 0) {
                    const videoTrack = videoTracks[0];
                    addLog(`üìπ Video: ${videoTrack.label} (${videoTrack.kind})`, 'success');
                }
                
                if (audioTracks.length > 0) {
                    const audioTrack = audioTracks[0];
                    addLog(`üé§ Audio: ${audioTrack.label} (${audioTrack.kind})`, 'success');
                }
                
                // Clean up
                stream.getTracks().forEach(track => track.stop());
                
            } catch (error) {
                addLog(`‚ùå Media access denied: ${error.message}`, 'error');
                updateStatus('Media permissions denied', 'error');
                
                if (error.name === 'NotAllowedError') {
                    addLog('üí° Tip: Enable camera and microphone in browser settings', 'warning');
                } else if (error.name === 'NotFoundError') {
                    addLog('üí° Tip: No camera or microphone found', 'warning');
                }
            }
        }
        
        // Auto-run basic tests on load
        window.addEventListener('load', () => {
            addLog('üöÄ Diagnostics page loaded', 'success');
            addLog('üí° Click the test buttons above to diagnose connection issues', 'info');
        });
    </script>
</body>
</html>
