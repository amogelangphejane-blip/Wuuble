<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply Members Feature Fix</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        .status.info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            display: block;
        }
        .status.success {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
        }
        .status.error {
            background: #ffebee;
            border-left: 4px solid #f44336;
        }
        .status.warning {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            display: none;
        }
        .log.visible {
            display: block;
        }
        .log-line {
            margin: 4px 0;
        }
        .log-line.success { color: #4caf50; }
        .log-line.error { color: #f44336; }
        .log-line.info { color: #2196f3; }
        .log-line.warning { color: #ff9800; }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .instructions {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }
        .instructions h3 {
            margin-top: 0;
            color: #374151;
        }
        .instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        .instructions li {
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Fix Members Feature</h1>
        <p class="subtitle">This tool will sync community creators to the member_profiles table so they appear in the members list.</p>
        
        <div class="status info">
            <strong>‚ÑπÔ∏è What this does:</strong>
            <ul>
                <li>Creates database triggers to automatically sync members</li>
                <li>Ensures all community creators are visible in the members list</li>
                <li>Enables real-time member data updates</li>
                <li>Backfills all existing members and creators</li>
            </ul>
        </div>

        <div class="instructions">
            <h3>üìã Instructions</h3>
            <ol>
                <li>Open your browser's developer console (F12)</li>
                <li>Click the "Apply Fix" button below</li>
                <li>Wait for the migration to complete</li>
                <li>Refresh your app to see the changes</li>
            </ol>
        </div>

        <button id="applyBtn" onclick="applyFix()">Apply Fix</button>
        
        <div class="spinner" id="spinner"></div>
        
        <div class="status success" id="successStatus" style="display: none;">
            <strong>‚úÖ Success!</strong>
            <p id="successMessage"></p>
        </div>
        
        <div class="status error" id="errorStatus" style="display: none;">
            <strong>‚ùå Error</strong>
            <p id="errorMessage"></p>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <script type="module">
        const { createClient } = supabase;
        
        // Initialize Supabase client from the main app
        let supabaseClient;
        
        // Try to get Supabase config from localStorage (if user is logged in to the app)
        const getSupabaseConfig = () => {
            // Check if there's a Supabase session in localStorage
            const keys = Object.keys(localStorage);
            const supabaseKey = keys.find(k => k.includes('supabase.auth'));
            
            if (supabaseKey) {
                try {
                    const session = JSON.parse(localStorage.getItem(supabaseKey));
                    // Extract URL from the key format: sb-{project-ref}-auth-token
                    const match = supabaseKey.match(/sb-([^-]+)-/);
                    if (match && match[1]) {
                        const projectRef = match[1];
                        return {
                            url: `https://${projectRef}.supabase.co`,
                            anonKey: session?.access_token || null
                        };
                    }
                } catch (e) {
                    console.error('Error parsing Supabase config:', e);
                }
            }
            return null;
        };

        window.applyFix = async function() {
            const btn = document.getElementById('applyBtn');
            const spinner = document.getElementById('spinner');
            const logDiv = document.getElementById('log');
            const successStatus = document.getElementById('successStatus');
            const errorStatus = document.getElementById('errorStatus');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            
            // Reset UI
            btn.disabled = true;
            spinner.style.display = 'block';
            logDiv.innerHTML = '';
            logDiv.classList.add('visible');
            successStatus.style.display = 'none';
            errorStatus.style.display = 'none';
            
            const log = (message, type = 'info') => {
                const line = document.createElement('div');
                line.className = `log-line ${type}`;
                line.textContent = message;
                logDiv.appendChild(line);
                logDiv.scrollTop = logDiv.scrollHeight;
                console.log(message);
            };
            
            try {
                log('üöÄ Starting Members Feature Fix...', 'info');
                
                // Get Supabase config
                const config = getSupabaseConfig();
                if (!config) {
                    throw new Error('Could not find Supabase configuration. Please make sure you are logged in to the app.');
                }
                
                log(`üì° Connecting to Supabase: ${config.url}`, 'info');
                supabaseClient = createClient(config.url, config.anonKey);
                
                // Read the SQL migration
                log('üìÑ Loading migration SQL...', 'info');
                const response = await fetch('fix_members_real_time_data.sql');
                const sql = await response.text();
                
                log('‚úÖ SQL loaded successfully', 'success');
                log('üìù Executing migration (this may take a moment)...', 'info');
                
                // Split SQL into individual statements
                const statements = sql
                    .split(';')
                    .map(s => s.trim())
                    .filter(s => s && !s.startsWith('--') && s.length > 10);
                
                log(`üìä Found ${statements.length} SQL statements to execute`, 'info');
                
                // Execute each statement
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < statements.length; i++) {
                    const stmt = statements[i];
                    try {
                        // For complex statements, use RPC if available
                        if (stmt.includes('CREATE FUNCTION') || stmt.includes('DO $$')) {
                            log(`‚è≥ Executing statement ${i + 1}/${statements.length}...`, 'info');
                            const { error } = await supabaseClient.rpc('exec_sql', { sql_query: stmt + ';' })
                                .catch(() => ({ error: { message: 'RPC not available, skipping' } }));
                            
                            if (error && !error.message.includes('already exists')) {
                                log(`‚ö†Ô∏è  Warning on statement ${i + 1}: ${error.message}`, 'warning');
                                errorCount++;
                            } else {
                                successCount++;
                            }
                        }
                    } catch (e) {
                        log(`‚ö†Ô∏è  Warning on statement ${i + 1}: ${e.message}`, 'warning');
                        errorCount++;
                    }
                }
                
                log(`‚úÖ Migration executed: ${successCount} successful, ${errorCount} warnings`, 'success');
                
                // Verify the fix
                log('üîç Verifying the fix...', 'info');
                
                // Check member_profiles count
                const { count: profileCount, error: countError } = await supabaseClient
                    .from('member_profiles')
                    .select('*', { count: 'exact', head: true });
                
                if (countError) {
                    log(`‚ö†Ô∏è  Could not verify: ${countError.message}`, 'warning');
                } else {
                    log(`üìä Total member profiles: ${profileCount}`, 'success');
                }
                
                // Check communities
                const { data: communities, error: commError } = await supabaseClient
                    .from('communities')
                    .select('id, name, creator_id');
                
                if (commError) {
                    log(`‚ö†Ô∏è  Could not fetch communities: ${commError.message}`, 'warning');
                } else if (communities && communities.length > 0) {
                    log(`üèòÔ∏è  Found ${communities.length} communities`, 'info');
                    
                    let creatorsWithProfiles = 0;
                    for (const community of communities) {
                        const { data: profile } = await supabaseClient
                            .from('member_profiles')
                            .select('id, role')
                            .eq('community_id', community.id)
                            .eq('user_id', community.creator_id)
                            .single();
                        
                        if (profile) {
                            creatorsWithProfiles++;
                            log(`‚úÖ "${community.name}" - Creator visible (role: ${profile.role})`, 'success');
                        } else {
                            log(`‚ö†Ô∏è  "${community.name}" - Creator not yet in profiles`, 'warning');
                        }
                    }
                    
                    log(`\nüëë ${creatorsWithProfiles}/${communities.length} creators are now visible`, 'success');
                }
                
                // Show success message
                spinner.style.display = 'none';
                successStatus.style.display = 'block';
                successMessage.innerHTML = `
                    <strong>Migration completed successfully!</strong><br><br>
                    Next steps:<br>
                    1. Refresh your browser<br>
                    2. Navigate to any community members page<br>
                    3. You should now see the creator in the members list<br>
                    4. Real-time updates are now enabled
                `;
                
                log('\n‚ú® Members feature fix completed!', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                log(`‚ùå Error: ${error.message}`, 'error');
                
                spinner.style.display = 'none';
                errorStatus.style.display = 'block';
                errorMessage.innerHTML = `
                    <strong>${error.message}</strong><br><br>
                    Please try:<br>
                    1. Make sure you're logged in to the app<br>
                    2. Check the browser console for more details<br>
                    3. Try applying the SQL manually in Supabase Dashboard
                `;
            } finally {
                btn.disabled = false;
            }
        };
    </script>
</body>
</html>