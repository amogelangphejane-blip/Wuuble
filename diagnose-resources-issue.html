<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resources Issue Diagnosis</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .warning { background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .info { background: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 5px; margin: 10px 0; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .loading { color: #666; font-style: italic; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîß Resources Error Diagnosis</h1>
    
    <div class="warning">
        <h3>üö® Issue: "Failed to load resources"</h3>
        <p>This diagnostic will check the exact cause of the resources loading error.</p>
    </div>

    <button onclick="runDiagnosis()">üîç Run Full Diagnosis</button>
    <button onclick="checkTables()">üìä Check Database Tables</button>
    <button onclick="testBasicConnection()">üîå Test Connection</button>

    <div id="results"></div>

    <script type="module">
        const SUPABASE_URL = "https://tgmflbglhmnrliredlbn.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnbWZsYmdsamhtbnJsaXJlZGxibiIsInJvbGUiOiJhbm9uIiwiaWF0IjoxNzMzNzE1NTU5LCJleHAiOjIwNDkyOTE1NTl9.YMJPKCJCJjF7lCKpPHHBvMlTX-LPwXZQYKN6m2LI0VE";

        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        window.testBasicConnection = async function() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">üîå Testing basic database connection...</div>';

            try {
                const { data, error } = await supabase.from('communities').select('id').limit(1);
                if (error) {
                    resultsDiv.innerHTML = `<div class="error">‚ùå Database Connection Failed: ${error.message}</div>`;
                } else {
                    resultsDiv.innerHTML = '<div class="success">‚úÖ Database Connection Successful!</div>';
                }
            } catch (err) {
                resultsDiv.innerHTML = `<div class="error">‚ùå Connection Error: ${err.message}</div>`;
            }
        };

        window.checkTables = async function() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">üìä Checking resource tables...</div>';

            const requiredTables = [
                'resource_categories',
                'community_resources',
                'resource_tags',
                'resource_tag_assignments',
                'resource_ratings',
                'resource_bookmarks',
                'resource_reports'
            ];

            let results = '<h3>üìä Database Table Status:</h3>';
            let allTablesExist = true;

            for (const table of requiredTables) {
                try {
                    const { data, error } = await supabase.from(table).select('*').limit(1);
                    if (error) {
                        if (error.code === '42P01') {
                            results += `<div class="error">‚ùå Table "${table}" does not exist</div>`;
                            allTablesExist = false;
                        } else {
                            results += `<div class="error">‚ùå Table "${table}": ${error.message}</div>`;
                            allTablesExist = false;
                        }
                    } else {
                        results += `<div class="success">‚úÖ Table "${table}" exists</div>`;
                    }
                } catch (err) {
                    results += `<div class="error">‚ùå Table "${table}": ${err.message}</div>`;
                    allTablesExist = false;
                }
            }

            if (!allTablesExist) {
                results += `
                    <div class="error">
                        <h4>üö® Root Cause Found!</h4>
                        <p><strong>The resources feature is failing because the required database tables are missing.</strong></p>
                    </div>
                    <div class="info">
                        <h4>üí° Solution:</h4>
                        <p>You need to apply the database migration to create the missing tables.</p>
                        <p><strong>Quick Fix:</strong></p>
                        <ol>
                            <li>Go to your <a href="https://supabase.com/dashboard/project/tgmflbglhmnrliredlbn/sql" target="_blank">Supabase SQL Editor</a></li>
                            <li>Copy the contents of <code>complete-resources-migration.sql</code></li>
                            <li>Paste and run the SQL script</li>
                            <li>Refresh your app and try accessing resources again</li>
                        </ol>
                    </div>`;
            } else {
                results += '<div class="success"><h4>‚úÖ All tables exist! Resources should be working.</h4></div>';
            }

            resultsDiv.innerHTML = results;
        };

        window.runDiagnosis = async function() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">üîç Running comprehensive diagnosis...</div>';

            let report = '<h3>üîß Comprehensive Diagnosis Report</h3>';

            // Test 1: Basic connection
            report += '<h4>1Ô∏è‚É£ Database Connection Test</h4>';
            try {
                const { data, error } = await supabase.from('communities').select('id').limit(1);
                if (error) {
                    report += `<div class="error">‚ùå Connection Failed: ${error.message}</div>`;
                    resultsDiv.innerHTML = report;
                    return;
                } else {
                    report += '<div class="success">‚úÖ Database connection successful</div>';
                }
            } catch (err) {
                report += `<div class="error">‚ùå Connection Error: ${err.message}</div>`;
                resultsDiv.innerHTML = report;
                return;
            }

            // Test 2: Check each required table
            report += '<h4>2Ô∏è‚É£ Required Tables Check</h4>';
            const requiredTables = [
                'resource_categories',
                'community_resources', 
                'resource_tags',
                'resource_tag_assignments',
                'resource_ratings',
                'resource_bookmarks',
                'resource_reports'
            ];

            let missingTables = [];
            for (const table of requiredTables) {
                try {
                    const { data, error } = await supabase.from(table).select('*').limit(1);
                    if (error && error.code === '42P01') {
                        report += `<div class="error">‚ùå Missing: ${table}</div>`;
                        missingTables.push(table);
                    } else if (error) {
                        report += `<div class="error">‚ùå Error accessing ${table}: ${error.message}</div>`;
                        missingTables.push(table);
                    } else {
                        report += `<div class="success">‚úÖ Found: ${table}</div>`;
                    }
                } catch (err) {
                    report += `<div class="error">‚ùå Error with ${table}: ${err.message}</div>`;
                    missingTables.push(table);
                }
            }

            // Test 3: Final diagnosis
            report += '<h4>3Ô∏è‚É£ Final Diagnosis</h4>';
            if (missingTables.length > 0) {
                report += `
                    <div class="error">
                        <h4>üéØ ROOT CAUSE IDENTIFIED</h4>
                        <p><strong>The "failed to load resources" error is caused by missing database tables.</strong></p>
                        <p>Missing tables: ${missingTables.join(', ')}</p>
                    </div>
                    <div class="warning">
                        <h4>üîß IMMEDIATE SOLUTION</h4>
                        <p><strong>Apply the database migration:</strong></p>
                        <ol>
                            <li>Open <a href="https://supabase.com/dashboard/project/tgmflbglhmnrliredlbn/sql" target="_blank">Supabase SQL Editor</a></li>
                            <li>Copy all contents from <code>complete-resources-migration.sql</code> file</li>
                            <li>Paste into SQL Editor and click "Run"</li>
                            <li>Wait for completion (should take 5-10 seconds)</li>
                            <li>Refresh your app and test resources again</li>
                        </ol>
                        <p><strong>Estimated fix time:</strong> 2-5 minutes</p>
                    </div>`;
            } else {
                report += `
                    <div class="success">
                        <h4>‚úÖ All Database Tables Found</h4>
                        <p>The database schema is correct. The issue might be elsewhere.</p>
                    </div>
                    <div class="info">
                        <h4>üîç Additional Checks Needed</h4>
                        <ul>
                            <li>Check browser console for JavaScript errors</li>
                            <li>Verify user authentication and permissions</li>
                            <li>Check if user is a member of the community</li>
                            <li>Review network tab for failed API requests</li>
                        </ul>
                    </div>`;
            }

            resultsDiv.innerHTML = report;
        };

        // Auto-run diagnosis on page load
        window.addEventListener('load', () => {
            setTimeout(runDiagnosis, 1000);
        });
    </script>

    <div class="info">
        <h3>üìã What This Diagnostic Checks</h3>
        <ul>
            <li>‚úÖ Supabase database connectivity</li>
            <li>üóÑÔ∏è Existence of all required resource tables</li>
            <li>üîí Basic table access permissions</li>
            <li>üí° Provides specific fix instructions</li>
        </ul>
    </div>

    <div class="warning">
        <h3>üöÄ Quick Fix Summary</h3>
        <p><strong>Most likely solution:</strong> The database migration needs to be applied.</p>
        <p>The resources feature code is complete, but the database tables don't exist yet.</p>
        <p><strong>File to run:</strong> <code>complete-resources-migration.sql</code></p>
    </div>
</body>
</html>