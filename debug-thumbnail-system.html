<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Thumbnail System</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background-color: #f5f5f5;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .warning {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        .loading {
            background-color: #e7f3ff;
            border-color: #b3d7ff;
            color: #004085;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .thumbnail-preview {
            max-width: 300px;
            max-height: 200px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
        }
        .stream-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .stream-card {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            background: #f9f9f9;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stream-thumbnail {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            background: linear-gradient(45deg, #6366f1, #ec4899);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-green { background-color: #28a745; }
        .status-red { background-color: #dc3545; }
        .status-yellow { background-color: #ffc107; }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            color: #6c757d;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß Thumbnail System Debugger</h1>
        <p>Comprehensive diagnostic tool for livestream thumbnail issues</p>
    </div>
    
    <div class="tabs">
        <button class="tab active" onclick="showTab('overview')">Overview</button>
        <button class="tab" onclick="showTab('database')">Database</button>
        <button class="tab" onclick="showTab('storage')">Storage</button>
        <button class="tab" onclick="showTab('upload')">Upload Test</button>
        <button class="tab" onclick="showTab('streams')">Live Streams</button>
    </div>

    <!-- Overview Tab -->
    <div id="overview-tab" class="tab-content active">
        <div class="test-section">
            <h2>üè• System Health Check</h2>
            <p>Running comprehensive checks on the thumbnail system...</p>
            <div id="health-status">Initializing...</div>
            <button onclick="runHealthCheck()">üîÑ Run Health Check</button>
        </div>

        <div class="test-section">
            <h2>üìä Quick Stats</h2>
            <div id="quick-stats">Loading...</div>
        </div>
    </div>

    <!-- Database Tab -->
    <div id="database-tab" class="tab-content">
        <div class="test-section">
            <h2>üóÑÔ∏è Database Connection</h2>
            <p>Testing connection to Supabase database...</p>
            <div id="db-connection-status">Testing...</div>
            <button onclick="testDatabaseConnection()">Test Connection</button>
        </div>

        <div class="test-section">
            <h2>üìã Schema Validation</h2>
            <p>Checking if all required tables and columns exist...</p>
            <div id="schema-status">Checking...</div>
            <button onclick="validateSchema()">Validate Schema</button>
        </div>

        <div class="test-section">
            <h2>üîê RLS Policies</h2>
            <p>Verifying Row Level Security policies...</p>
            <div id="rls-status">Checking...</div>
            <button onclick="checkRLSPolicies()">Check Policies</button>
        </div>
    </div>

    <!-- Storage Tab -->
    <div id="storage-tab" class="tab-content">
        <div class="test-section">
            <h2>ü™£ Storage Buckets</h2>
            <p>Checking if storage buckets exist and are properly configured...</p>
            <div id="buckets-status">Testing...</div>
            <button onclick="testStorageBuckets()">Check Buckets</button>
        </div>

        <div class="test-section">
            <h2>üîí Storage Policies</h2>
            <p>Verifying storage access policies...</p>
            <div id="storage-policies-status">Checking...</div>
            <button onclick="checkStoragePolicies()">Check Policies</button>
        </div>

        <div class="test-section">
            <h2>üìÅ Storage Contents</h2>
            <p>Listing existing thumbnails in storage...</p>
            <div id="storage-contents">Loading...</div>
            <button onclick="listStorageContents()">List Contents</button>
        </div>
    </div>

    <!-- Upload Test Tab -->
    <div id="upload-tab" class="tab-content">
        <div class="test-section">
            <h2>üì§ Thumbnail Upload Test</h2>
            <p>Test uploading a thumbnail (requires a stream):</p>
            <div style="margin: 15px 0;">
                <input type="file" id="thumbnail-file" accept="image/*" style="margin-bottom: 10px;">
                <br>
                <input type="text" id="stream-id" placeholder="Enter Stream ID" style="margin: 5px; padding: 8px; width: 300px;">
                <br>
                <label>
                    <input type="checkbox" id="debug-upload"> Enable debug logging
                </label>
            </div>
            <button onclick="uploadThumbnailTest()">üöÄ Upload Thumbnail</button>
            <div id="upload-status"></div>
            <img id="thumbnail-preview" class="thumbnail-preview" style="display: none;">
        </div>

        <div class="test-section">
            <h2>üß™ Thumbnail Service Test</h2>
            <p>Test the thumbnail service configuration:</p>
            <div id="service-test-status">Ready to test...</div>
            <button onclick="testThumbnailService()">Test Service</button>
        </div>
    </div>

    <!-- Live Streams Tab -->
    <div id="streams-tab" class="tab-content">
        <div class="test-section">
            <h2>üì∫ Live Streams Analysis</h2>
            <p>Loading live streams to analyze thumbnail data...</p>
            <div id="streams-analysis-status">Loading...</div>
            <button onclick="analyzeStreams()">üîç Analyze Streams</button>
            <div id="streams-list"></div>
        </div>
    </div>

    <div class="debug-info" id="debug-log">
        <strong>Debug Log:</strong><br>
        System initialized. Click any test to begin diagnostics.
    </div>

    <script>
        let supabase;
        let debugLog = [];

        // Initialize Supabase client
        function initializeSupabase() {
            const url = localStorage.getItem('supabase_url') || prompt('Enter your Supabase URL:');
            const key = localStorage.getItem('supabase_key') || prompt('Enter your Supabase Anon Key:');
            
            if (url && key) {
                localStorage.setItem('supabase_url', url);
                localStorage.setItem('supabase_key', key);
                supabase = window.supabase.createClient(url, key);
                log('‚úÖ Supabase client initialized');
                return true;
            }
            log('‚ùå Failed to initialize Supabase client');
            return false;
        }

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.push(`[${timestamp}] ${message}`);
            const logElement = document.getElementById('debug-log');
            logElement.innerHTML = '<strong>Debug Log:</strong><br>' + debugLog.slice(-50).join('<br>');
            logElement.scrollTop = logElement.scrollHeight;
        }

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        async function runHealthCheck() {
            const statusDiv = document.getElementById('health-status');
            statusDiv.className = 'loading';
            statusDiv.innerHTML = 'üîÑ Running comprehensive health check...';
            
            log('üè• Starting system health check');
            
            const checks = [
                { name: 'Supabase Connection', test: testDatabaseConnection },
                { name: 'Storage Buckets', test: testStorageBuckets },
                { name: 'Schema Validation', test: validateSchema },
                { name: 'Thumbnail Service', test: testThumbnailService }
            ];
            
            let results = [];
            
            for (const check of checks) {
                try {
                    log(`üîç Testing: ${check.name}`);
                    const result = await check.test();
                    results.push({ name: check.name, status: 'success', message: 'Passed' });
                } catch (error) {
                    results.push({ name: check.name, status: 'error', message: error.message });
                    log(`‚ùå ${check.name} failed: ${error.message}`);
                }
            }
            
            const passedCount = results.filter(r => r.status === 'success').length;
            const totalCount = results.length;
            
            let html = `<h3>Health Check Results (${passedCount}/${totalCount} passed)</h3>`;
            
            results.forEach(result => {
                const indicator = result.status === 'success' ? 
                    '<span class="status-indicator status-green"></span>' : 
                    '<span class="status-indicator status-red"></span>';
                html += `<div>${indicator}${result.name}: ${result.message}</div>`;
            });
            
            statusDiv.className = passedCount === totalCount ? 'success' : 'error';
            statusDiv.innerHTML = html;
            
            // Update quick stats
            updateQuickStats();
        }

        async function testDatabaseConnection() {
            log('üîç Testing database connection');
            
            if (!initializeSupabase()) {
                throw new Error('Failed to initialize Supabase client');
            }
            
            const { data, error } = await supabase.from('live_streams').select('count').limit(1);
            if (error) throw error;
            
            log('‚úÖ Database connection successful');
            return true;
        }

        async function testStorageBuckets() {
            log('üîç Testing storage buckets');
            
            const { data: buckets, error } = await supabase.storage.listBuckets();
            if (error) throw error;
            
            const expectedBuckets = ['stream-thumbnails', 'stream-display-images'];
            const existingBuckets = buckets.map(b => b.name);
            
            const missingBuckets = expectedBuckets.filter(b => !existingBuckets.includes(b));
            
            if (missingBuckets.length > 0) {
                throw new Error(`Missing buckets: ${missingBuckets.join(', ')}`);
            }
            
            log('‚úÖ All required storage buckets exist');
            return true;
        }

        async function validateSchema() {
            log('üîç Validating database schema');
            
            // Test if we can query the required columns
            const { data, error } = await supabase
                .from('live_streams')
                .select('id, thumbnail_url, display_image_url, title, creator_id')
                .limit(1);
                
            if (error) throw error;
            
            log('‚úÖ Database schema validation passed');
            return true;
        }

        async function testThumbnailService() {
            log('üîç Testing thumbnail service configuration');
            
            // Test authentication
            const { data: user, error: authError } = await supabase.auth.getUser();
            if (authError && !authError.message.includes('not authenticated')) {
                throw new Error(`Authentication test failed: ${authError.message}`);
            }
            
            // Test bucket access
            const { data: buckets, error: bucketError } = await supabase.storage.listBuckets();
            if (bucketError) {
                throw new Error(`Storage access failed: ${bucketError.message}`);
            }
            
            const hasThumbnailBucket = buckets.some(b => b.name === 'stream-thumbnails');
            if (!hasThumbnailBucket) {
                throw new Error('stream-thumbnails bucket not found');
            }
            
            log('‚úÖ Thumbnail service configuration is valid');
            return true;
        }

        async function analyzeStreams() {
            const statusDiv = document.getElementById('streams-analysis-status');
            const listDiv = document.getElementById('streams-list');
            
            statusDiv.className = 'loading';
            statusDiv.textContent = 'üîç Analyzing streams...';
            listDiv.innerHTML = '';
            
            log('üì∫ Starting stream analysis');
            
            try {
                const { data: streams, error } = await supabase
                    .from('live_streams')
                    .select(`
                        id, 
                        title, 
                        thumbnail_url, 
                        display_image_url, 
                        status,
                        visibility,
                        creator_id,
                        created_at,
                        profiles(display_name)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(20);
                    
                if (error) throw error;
                
                statusDiv.className = 'success';
                statusDiv.innerHTML = `‚úÖ Analyzed ${streams.length} streams`;
                
                if (streams.length === 0) {
                    listDiv.innerHTML = '<p>No streams found. Create a stream first to test thumbnails.</p>';
                    return;
                }
                
                let thumbnailCount = 0;
                let displayImageCount = 0;
                
                listDiv.className = 'stream-list';
                streams.forEach(stream => {
                    const hasThumbnail = !!stream.thumbnail_url;
                    const hasDisplayImage = !!stream.display_image_url;
                    
                    if (hasThumbnail) thumbnailCount++;
                    if (hasDisplayImage) displayImageCount++;
                    
                    const card = document.createElement('div');
                    card.className = 'stream-card';
                    
                    const imageUrl = stream.display_image_url || stream.thumbnail_url;
                    const imageStatus = hasDisplayImage ? 'üñºÔ∏è Display Image' : hasThumbnail ? 'üñºÔ∏è Thumbnail' : '‚ùå No Image';
                    
                    card.innerHTML = `
                        <div class="stream-thumbnail" ${imageUrl ? `style="background: none; padding: 0;"` : ''}>
                            ${imageUrl ? 
                                `<img src="${imageUrl}" alt="Thumbnail" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;" 
                                     onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'color: white; text-align: center;\\'>‚ùå Image Failed</div>'"
                                     onload="console.log('‚úÖ Image loaded for stream ${stream.id}')"
                                 >` : 
                                '‚ùå No Thumbnail'
                            }
                        </div>
                        <h4 style="margin: 10px 0 5px 0; font-size: 16px; color: #333;">${stream.title}</h4>
                        <div style="font-size: 12px; color: #666; line-height: 1.4;">
                            <div><strong>ID:</strong> ${stream.id}</div>
                            <div><strong>Status:</strong> ${stream.status}</div>
                            <div><strong>Visibility:</strong> ${stream.visibility}</div>
                            <div><strong>Creator:</strong> ${stream.profiles?.display_name || 'Unknown'}</div>
                            <div><strong>Image Status:</strong> ${imageStatus}</div>
                            ${stream.thumbnail_url ? `<div><strong>Thumbnail URL:</strong> <a href="${stream.thumbnail_url}" target="_blank">View</a></div>` : ''}
                            ${stream.display_image_url ? `<div><strong>Display Image URL:</strong> <a href="${stream.display_image_url}" target="_blank">View</a></div>` : ''}
                        </div>
                    `;
                    
                    listDiv.appendChild(card);
                });
                
                log(`üìä Analysis complete: ${thumbnailCount} thumbnails, ${displayImageCount} display images`);
                
            } catch (error) {
                statusDiv.className = 'error';
                statusDiv.textContent = `‚ùå Analysis failed: ${error.message}`;
                log(`‚ùå Stream analysis failed: ${error.message}`);
            }
        }

        async function uploadThumbnailTest() {
            const fileInput = document.getElementById('thumbnail-file');
            const streamIdInput = document.getElementById('stream-id');
            const debugCheckbox = document.getElementById('debug-upload');
            const statusDiv = document.getElementById('upload-status');
            const previewImg = document.getElementById('thumbnail-preview');
            
            const file = fileInput.files[0];
            const streamId = streamIdInput.value.trim();
            const debugMode = debugCheckbox.checked;
            
            if (!file) {
                statusDiv.className = 'error';
                statusDiv.textContent = '‚ùå Please select a file';
                return;
            }
            
            if (!streamId) {
                statusDiv.className = 'error';
                statusDiv.textContent = '‚ùå Please enter a stream ID';
                return;
            }
            
            statusDiv.className = 'loading';
            statusDiv.textContent = '‚è≥ Uploading thumbnail...';
            previewImg.style.display = 'none';
            
            log(`üì§ Starting thumbnail upload test for stream ${streamId}`);
            
            try {
                // Enable debug mode if requested
                if (debugMode) {
                    localStorage.setItem('thumbnail_debug', 'true');
                }
                
                // Generate filename
                const fileExt = file.name.split('.').pop();
                const fileName = `${streamId}/thumbnail-${Date.now()}.${fileExt}`;
                
                log(`üìÅ Generated filename: ${fileName}`);
                
                // Upload to stream-thumbnails bucket
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('stream-thumbnails')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: true
                    });
                
                if (uploadError) throw uploadError;
                
                log(`‚úÖ File uploaded successfully: ${uploadData.path}`);
                
                // Get public URL
                const { data: urlData } = supabase.storage
                    .from('stream-thumbnails')
                    .getPublicUrl(fileName);
                
                log(`üîó Public URL generated: ${urlData.publicUrl}`);
                
                // Update stream record
                const { error: updateError } = await supabase
                    .from('live_streams')
                    .update({ 
                        thumbnail_url: urlData.publicUrl,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', streamId);
                
                if (updateError) throw updateError;
                
                statusDiv.className = 'success';
                statusDiv.innerHTML = `
                    ‚úÖ Thumbnail uploaded successfully!<br>
                    <small>URL: <a href="${urlData.publicUrl}" target="_blank">${urlData.publicUrl}</a></small>
                `;
                
                // Show preview
                previewImg.src = urlData.publicUrl;
                previewImg.style.display = 'block';
                
                log(`üéâ Thumbnail upload completed successfully`);
                
                // Clean up debug mode
                if (debugMode) {
                    localStorage.removeItem('thumbnail_debug');
                }
                
            } catch (error) {
                statusDiv.className = 'error';
                statusDiv.textContent = `‚ùå Upload failed: ${error.message}`;
                log(`‚ùå Thumbnail upload failed: ${error.message}`);
                
                // Clean up debug mode
                if (debugMode) {
                    localStorage.removeItem('thumbnail_debug');
                }
            }
        }

        async function updateQuickStats() {
            const statsDiv = document.getElementById('quick-stats');
            
            try {
                // Get stream counts
                const { data: streams, error: streamError } = await supabase
                    .from('live_streams')
                    .select('thumbnail_url, display_image_url, status');
                
                if (streamError) throw streamError;
                
                const totalStreams = streams.length;
                const withThumbnails = streams.filter(s => s.thumbnail_url).length;
                const withDisplayImages = streams.filter(s => s.display_image_url).length;
                const liveStreams = streams.filter(s => s.status === 'live').length;
                
                // Get bucket info
                const { data: buckets } = await supabase.storage.listBuckets();
                const thumbnailBucket = buckets?.find(b => b.name === 'stream-thumbnails');
                
                statsDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="text-align: center; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #1976d2;">${totalStreams}</div>
                            <div style="color: #666;">Total Streams</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f3e5f5; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #7b1fa2;">${withThumbnails}</div>
                            <div style="color: #666;">With Thumbnails</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #388e3c;">${withDisplayImages}</div>
                            <div style="color: #666;">With Display Images</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #ffebee; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #d32f2f;">${liveStreams}</div>
                            <div style="color: #666;">Live Now</div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                statsDiv.innerHTML = `<div class="error">Failed to load stats: ${error.message}</div>`;
            }
        }

        // Initialize on page load
        window.onload = function() {
            if (initializeSupabase()) {
                runHealthCheck();
            }
        };
    </script>
</body>
</html>